{"openapi":"3.1.0","info":{"title":"AI Factory Client Service","description":"Manages client groups on HPC clusters via SLURM. Provides job submission, metrics collection via Prometheus, and log management. Client groups can be used by benchmark orchestrators or other services.","version":"1.0.0"},"paths":{"/health":{"get":{"summary":"Health","description":"Health check endpoint.","operationId":"health_health_get","responses":{"200":{"description":"Successful Response","content":{"application/json":{"schema":{}}}}}}},"/api/v1/client-groups":{"get":{"tags":["Client Groups"],"summary":"List all client groups","description":"List all active client groups.\n\nReturns a list of benchmark IDs for all currently managed client groups.\n\n**Returns:**\n```json\n{\n  \"groups\": [12345, 12346, 12347],\n  \"count\": 3\n}\n```\n\n**Example:**\n```bash\ncurl http://localhost:8002/api/v1/client-groups\n```","operationId":"list_client_groups_api_v1_client_groups_get","responses":{"200":{"description":"Successful Response","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ClientGroupListResponse"}}}}}},"post":{"tags":["Client Groups"],"summary":"Create a new client group","description":"Create a new client group for load testing.\n\nA client group represents a SLURM job that will spawn multiple concurrent clients\nto send requests to AI inference services. The service automatically generates a unique\ngroup ID and returns it in the response.\n\n**Request Body:**\n- `service_id`: Service ID of the vLLM service to test (the client service will resolve the data-plane endpoint)\n- `num_clients`: Number of concurrent clients (1-10000)\n- `requests_per_second`: Target RPS across all clients (e.g., 10.0)\n- `duration_seconds`: Load test duration (e.g., 60)\n- `prompts`: List of prompts to randomly select from\n- `max_tokens`: Maximum tokens per request (default: 100)\n- `temperature`: Sampling temperature (default: 0.7)\n- `model`: Model name (optional, uses server default)\n- `time_limit`: SLURM job time limit in minutes (default: 30)\n\n    **Returns (Success):**\n    ```json\n    {\n        \"status\": \"created\",\n        \"group_id\": 12345,\n        \"num_clients\": 10,\n        \"message\": \"Load generator job submitted for service 3732769\"\n    }\n    ```\n\n**Example:**\n    ```bash\n    curl -X POST \"http://localhost:8002/api/v1/client-groups\" \\\n        -H \"Content-Type: application/json\" \\\n        -d '{\n            \"service_id\": \"3732769\",\n            \"num_clients\": 5,\n            \"requests_per_second\": 2.0,\n            \"duration_seconds\": 60,\n            \"prompts\": [\"What is AI?\", \"Explain machine learning.\"],\n            \"max_tokens\": 50,\n            \"time_limit\": 10\n        }'\n    ```\n\n**Workflow:**\n1. Client Service generates a unique group ID\n2. Validates the request\n3. Creates a ClientGroup object with load test configuration\n4. Submits a SLURM job to HPC cluster\n5. SLURM job runs load generator on compute node\n6. Load generator sends requests to target vLLM endpoint\n7. Results are saved to logs directory\n8. Returns immediately with the group ID (job runs asynchronously)\n\n**Note:** The load test runs asynchronously. Use `GET /client-groups/{group_id}`\nto check status and retrieve results after completion.","operationId":"create_client_group_api_v1_client_groups_post","requestBody":{"content":{"application/json":{"schema":{"$ref":"#/components/schemas/CreateClientGroupRequest"}}},"required":true},"responses":{"201":{"description":"Client group created successfully","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ClientGroupResponse"}}}},"422":{"description":"Validation Error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/api/v1/client-groups/{group_id}":{"get":{"tags":["Client Groups"],"summary":"Get client group information","description":"Get detailed information about a specific client group.\n\nReturns the number of clients, registration status, and client process address.\n\n**Path Parameters:**\n- `group_id`: Unique identifier for the client group\n\n**Returns (Success):**\n```json\n{\n  \"group_id\": 12345,\n  \"info\": {\n    \"num_clients\": 100,\n    \"client_address\": \"http://mel2079:8000\",\n    \"created_at\": 1699999999.123,\n    \"status\": \"running\"\n  }\n}\n```\n\n**Returns (Not Found):**\n```json\n{\n  \"detail\": \"Client group not found\",\n  \"status_code\": 404\n}\n```\n\n**Example:**\n```bash\ncurl http://localhost:8002/api/v1/client-groups/12345\n```\n\n**Status Values:**\n- `pending`: SLURM job submitted, waiting for client process to register\n- `running`: Client process registered and ready to accept commands\n- `stopped`: Client group has been terminated","operationId":"get_client_group_info_api_v1_client_groups__group_id__get","parameters":[{"name":"group_id","in":"path","required":true,"schema":{"type":"integer","title":"Group Id"}}],"responses":{"200":{"description":"Client group information retrieved","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ClientGroupInfoResponse"}}}},"404":{"description":"Client group not found","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ErrorResponse"}}}},"422":{"description":"Validation Error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}},"delete":{"tags":["Client Groups"],"summary":"Delete a client group","description":"Remove a client group and stop its associated SLURM job.\n\n**Path Parameters:**\n- `group_id`: Unique identifier for the client group\n\n**Returns:**\n```json\n{\n  \"status\": \"deleted\",\n  \"group_id\": 12345\n}\n```\n\n**Example:**\n```bash\ncurl -X DELETE http://localhost:8002/api/v1/client-groups/12345\n```\n\n**Note:** This only removes the group from the Client Service's tracking.\nThe SLURM job will continue running until its time limit or manual cancellation.","operationId":"delete_client_group_api_v1_client_groups__group_id__delete","parameters":[{"name":"group_id","in":"path","required":true,"schema":{"type":"integer","title":"Group Id"}}],"responses":{"200":{"description":"Successful Response","content":{"application/json":{"schema":{}}}},"422":{"description":"Validation Error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/api/v1/client-groups/targets":{"get":{"tags":["Monitoring"],"summary":"Get Prometheus scrape targets for all client groups","description":"Get Prometheus scrape targets for all managed client groups.\n\nThis endpoint returns a list of Prometheus scrape targets for running client processes.\nUse this to dynamically configure Prometheus to monitor all active client groups.\n\n**Returns:**\n```json\n[\n  {\n    \"targets\": [\"mel2079:8000\"],\n    \"labels\": {\n      \"job\": \"client-group-12345\",\n      \"group_id\": \"12345\",\n      \"num_clients\": \"100\",\n      \"status\": \"running\"\n    }\n  },\n  {\n    \"targets\": [\"mel2080:8000\"],\n    \"labels\": {\n      \"job\": \"client-group-12346\",\n      \"group_id\": \"12346\",\n      \"num_clients\": \"50\",\n      \"status\": \"running\"\n    }\n  }\n]\n```\n\n**Integration with Prometheus:**\nSave this output to a file and configure Prometheus file-based service discovery:\n\n```yaml\n# prometheus.yml\nscrape_configs:\n  - job_name: 'client-groups'\n    file_sd_configs:\n      - files:\n        - 'targets/client_groups.json'\n    refresh_interval: 30s\n```\n\nUpdate the file periodically:\n```bash\ncurl http://localhost:8002/api/v1/client-groups/targets > targets/client_groups.json\n```\n\n**Example:**\n```bash\ncurl http://localhost:8002/api/v1/client-groups/targets\n```","operationId":"get_client_group_targets_api_v1_client_groups_targets_get","responses":{"200":{"description":"Successful Response","content":{"application/json":{"schema":{"items":{"$ref":"#/components/schemas/MetricsTarget"},"type":"array","title":"Response Get Client Group Targets Api V1 Client Groups Targets Get"}}}}}}},"/api/v1/client-groups/{group_id}/metrics":{"get":{"tags":["Monitoring"],"summary":"Get Prometheus metrics from a client group","description":"Get Prometheus-compatible metrics from a specific client group.\n\nThis endpoint proxies the /metrics endpoint from the client process running on HPC.\nClient processes expose metrics about requests sent, latencies, errors, and more.\n\n**Path Parameters:**\n- `group_id`: Unique identifier for the client group\n\n**Available Metrics (typical):**\n- `client_requests_total` - Total number of requests sent\n- `client_requests_success` - Number of successful requests\n- `client_requests_failed` - Number of failed requests\n- `client_latency_seconds` - Request latency histogram\n- `client_tokens_per_second` - Throughput in tokens/second\n- `client_active_connections` - Number of active client threads\n\n**Returns (Success):**\n- Content-Type: `text/plain; version=0.0.4`\n- Body: Prometheus text format metrics\n\n**Example Success Response:**\n```\n# HELP client_requests_total Total requests sent by clients\n# TYPE client_requests_total counter\nclient_requests_total{group_id=\"12345\"} 1500.0\n# HELP client_latency_seconds Request latency distribution\n# TYPE client_latency_seconds histogram\nclient_latency_seconds_bucket{le=\"0.1\"} 800\nclient_latency_seconds_bucket{le=\"0.5\"} 1200\nclient_latency_seconds_bucket{le=\"1.0\"} 1450\nclient_latency_seconds_bucket{le=\"+Inf\"} 1500\nclient_latency_seconds_sum 456.7\nclient_latency_seconds_count 1500\n```\n\n**Returns (Not Ready):**\n```json\n{\n  \"detail\": \"Client process not registered yet\",\n  \"status_code\": 404\n}\n```\n\n**Integration with Prometheus:**\nUse the `/client-groups/targets` endpoint for automatic discovery, or configure manually:\n\n```yaml\nscrape_configs:\n  - job_name: 'client-group-12345'\n    static_configs:\n      - targets: ['localhost:8002']\n    metrics_path: '/api/v1/client-groups/12345/metrics'\n    scrape_interval: 15s\n```\n\n**Example:**\n```bash\ncurl http://localhost:8002/api/v1/client-groups/12345/metrics\n```\n\n**Note:** Metrics are collected from the actual client process running on HPC.\nIf the client process hasn't registered yet, this endpoint will return 404.","operationId":"get_client_group_metrics_api_v1_client_groups__group_id__metrics_get","parameters":[{"name":"group_id","in":"path","required":true,"schema":{"type":"integer","title":"Group Id"}}],"responses":{"200":{"description":"Metrics in Prometheus text format","content":{"application/json":{"schema":{}},"text/plain":{"example":"# HELP client_requests_total Total requests sent\\n# TYPE client_requests_total counter\\nclient_requests_total 1500\\n"}}},"404":{"description":"Client group not found or not ready","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ErrorResponse"}}}},"422":{"description":"Validation Error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}}},"components":{"schemas":{"ClientGroupInfo":{"properties":{"num_clients":{"type":"integer","title":"Num Clients","description":"Number of clients in the group"},"client_address":{"anyOf":[{"type":"string"},{"type":"null"}],"title":"Client Address","description":"Address of the registered client process"},"created_at":{"type":"number","title":"Created At","description":"Unix timestamp when the group was created"},"status":{"type":"string","title":"Status","description":"Current status: pending, running, stopped","default":"pending"},"job_id":{"anyOf":[{"type":"string"},{"type":"null"}],"title":"Job Id","description":"SLURM job ID for this load test"},"load_config":{"anyOf":[{"additionalProperties":true,"type":"object"},{"type":"null"}],"title":"Load Config","description":"Load test configuration"}},"type":"object","required":["num_clients","created_at"],"title":"ClientGroupInfo","description":"Information about a client group."},"ClientGroupInfoResponse":{"properties":{"group_id":{"type":"integer","title":"Group Id","description":"Client group identifier"},"info":{"$ref":"#/components/schemas/ClientGroupInfo","description":"Detailed group information"}},"type":"object","required":["group_id","info"],"title":"ClientGroupInfoResponse","description":"Response with detailed client group information."},"ClientGroupListResponse":{"properties":{"groups":{"items":{"type":"integer"},"type":"array","title":"Groups","description":"List of active group IDs"},"count":{"type":"integer","title":"Count","description":"Total number of active groups"}},"type":"object","required":["groups","count"],"title":"ClientGroupListResponse","description":"Response listing all client groups."},"ClientGroupResponse":{"properties":{"status":{"type":"string","title":"Status","description":"Operation status","example":"created"},"group_id":{"type":"integer","title":"Group Id","description":"Unique identifier for the client group"},"num_clients":{"anyOf":[{"type":"integer"},{"type":"null"}],"title":"Num Clients","description":"Number of clients in the group"},"message":{"anyOf":[{"type":"string"},{"type":"null"}],"title":"Message","description":"Additional information"}},"type":"object","required":["status","group_id"],"title":"ClientGroupResponse","description":"Response after creating or updating a client group."},"CreateClientGroupRequest":{"properties":{"service_id":{"type":"string","title":"Service Id","description":"Service ID of the vLLM service to test","example":"3732769"},"num_clients":{"type":"integer","exclusiveMinimum":0.0,"title":"Num Clients","description":"Number of concurrent clients to spawn","example":10},"requests_per_second":{"type":"number","exclusiveMinimum":0.0,"title":"Requests Per Second","description":"Target requests per second across all clients","default":10.0,"example":10.0},"duration_seconds":{"type":"integer","exclusiveMinimum":0.0,"title":"Duration Seconds","description":"Load test duration in seconds","default":60,"example":60},"prompts":{"items":{"type":"string"},"type":"array","minItems":1,"title":"Prompts","description":"List of prompts to randomly select from during testing","default":["Tell me a story about AI."],"example":["What is machine learning?","Explain neural networks."]},"max_tokens":{"type":"integer","maximum":4096.0,"exclusiveMinimum":0.0,"title":"Max Tokens","description":"Maximum tokens to generate per request","default":100,"example":100},"temperature":{"type":"number","maximum":2.0,"minimum":0.0,"title":"Temperature","description":"Sampling temperature for generation","default":0.7,"example":0.7},"time_limit":{"type":"integer","maximum":1440.0,"exclusiveMinimum":0.0,"title":"Time Limit","description":"SLURM job time limit in minutes (should be > duration_seconds/60)","default":5,"example":5}},"type":"object","required":["service_id","num_clients"],"title":"CreateClientGroupRequest","description":"Request to create a new client group for load testing.","examples":[{"duration_seconds":60,"max_tokens":50,"num_clients":5,"prompts":["What is AI?","Explain deep learning."],"requests_per_second":5.0,"service_id":"3732769","time_limit":10},{"duration_seconds":300,"max_tokens":200,"num_clients":100,"prompts":["Tell me a story.","Write a poem."],"requests_per_second":100.0,"service_id":"3732769","temperature":0.9,"time_limit":15}]},"ErrorResponse":{"properties":{"detail":{"type":"string","title":"Detail","description":"Error message","example":"Client group not found"},"status_code":{"type":"integer","title":"Status Code","description":"HTTP status code","example":404}},"type":"object","required":["detail","status_code"],"title":"ErrorResponse","description":"Error response model"},"HTTPValidationError":{"properties":{"detail":{"items":{"$ref":"#/components/schemas/ValidationError"},"type":"array","title":"Detail"}},"type":"object","title":"HTTPValidationError"},"MetricsTarget":{"properties":{"targets":{"items":{"type":"string"},"type":"array","title":"Targets","description":"List of target endpoints"},"labels":{"additionalProperties":{"type":"string"},"type":"object","title":"Labels","description":"Labels for the target"}},"type":"object","required":["targets","labels"],"title":"MetricsTarget","description":"Prometheus scrape target configuration."},"ValidationError":{"properties":{"loc":{"items":{"anyOf":[{"type":"string"},{"type":"integer"}]},"type":"array","title":"Location"},"msg":{"type":"string","title":"Message"},"type":{"type":"string","title":"Error Type"}},"type":"object","required":["loc","msg","type"],"title":"ValidationError"}}},"tags":[{"name":"System","description":"Health checks and system status"},{"name":"Client Groups","description":"Create and manage client groups"},{"name":"Execution","description":"Trigger client group execution"},{"name":"Monitoring","description":"Prometheus metrics and targets"},{"name":"Logs","description":"Sync and manage SLURM job logs"}]}