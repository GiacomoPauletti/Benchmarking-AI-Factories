{
  "datasource": {
    "type": "yesoreyeram-infinity-datasource",
    "uid": "af28rrswju6m8c"
  },
  "fieldConfig": {
    "defaults": {},
    "overrides": []
  },
  "gridPos": {
    "h": 4,
    "w": 24,
    "x": 0,
    "y": 0
  },
  "id": 100,
  "options": {
    "buttonGroup": {
      "orientation": "center",
      "size": "lg"
    },
    "confirmModal": {
      "body": "Please confirm the action",
      "cancel": "Cancel",
      "columns": {
        "include": ["name", "oldValue", "newValue"],
        "name": "Label",
        "newValue": "New Value",
        "oldValue": "Old Value"
      },
      "confirm": "Confirm",
      "elementDisplayMode": "modified",
      "title": "Confirm action"
    },
    "elementValueChanged": "",
    "elements": [
      {
        "id": "time_limit_minutes",
        "labelWidth": 12,
        "max": 240,
        "min": 5,
        "section": "",
        "showIf": "const status = context.panel.data.series && context.panel.data.series[0];\nif (!status) return true;\nconst running = status.fields.find(f => f.name === 'running');\nreturn !running || !running.values[0];",
        "step": 5,
        "title": "Session Duration (min)",
        "tooltip": "SLURM job time limit in minutes (5-240)",
        "type": "slider",
        "value": 30
      },
      {
        "id": "remaining_display",
        "labelWidth": 12,
        "section": "",
        "showIf": "const status = context.panel.data.series && context.panel.data.series[0];\nif (!status) return false;\nconst running = status.fields.find(f => f.name === 'running');\nreturn running && running.values[0];",
        "title": "Time Remaining",
        "type": "disabled",
        "value": ""
      }
    ],
    "initial": {
      "code": "// Fetch orchestrator status and update display\nconst status = context.panel.data.series && context.panel.data.series[0];\nif (status) {\n  const remainingField = status.fields.find(f => f.name === 'remaining_seconds');\n  const remaining = remainingField ? remainingField.values[0] : null;\n  if (remaining !== null && remaining !== undefined) {\n    const mins = Math.floor(remaining / 60);\n    const secs = remaining % 60;\n    context.panel.setFormValue({\n      'remaining_display': `${mins}m ${secs}s`\n    });\n  }\n}",
      "contentType": "application/json",
      "getPayload": "return {}",
      "highlight": false,
      "highlightColor": "red",
      "method": "query",
      "payload": {},
      "url": ""
    },
    "layout": {
      "orientation": "horizontal",
      "padding": 10,
      "sectionVariant": "default",
      "variant": "single"
    },
    "reset": {
      "backgroundColor": "red",
      "foregroundColor": "white",
      "icon": "times",
      "showIf": "const status = context.panel.data.series && context.panel.data.series[0];\nif (!status) return false;\nconst running = status.fields.find(f => f.name === 'running');\nreturn running && running.values[0];",
      "text": "Stop Orchestrator",
      "variant": "destructive"
    },
    "resetAction": {
      "code": "if (context.panel.response && context.panel.response.ok) {\n  context.grafana.notifySuccess(['Orchestrator', 'Orchestrator stopped successfully!']);\n  context.grafana.refresh();\n} else {\n  const errMsg = context.panel.response ? 'Failed to stop orchestrator' : 'No response';\n  context.grafana.notifyError(['Orchestrator', errMsg]);\n}",
      "confirm": true,
      "contentType": "application/json",
      "getPayload": "return {}",
      "mode": "custom",
      "method": "POST",
      "payload": {},
      "url": "http://${server}:${port}/api/v1/orchestrator/stop"
    },
    "saveDefault": {
      "icon": "save",
      "text": "Save Default",
      "variant": "hidden"
    },
    "submit": {
      "backgroundColor": "green",
      "foregroundColor": "white",
      "icon": "play",
      "showIf": "const status = context.panel.data.series && context.panel.data.series[0];\nif (!status) return true;\nconst running = status.fields.find(f => f.name === 'running');\nreturn !running || !running.values[0];",
      "text": "Start Orchestrator",
      "variant": "primary"
    },
    "sync": true,
    "update": {
      "code": "if (context.panel.response && context.panel.response.ok) {\n  context.grafana.notifySuccess(['Orchestrator', 'Orchestrator started successfully!']);\n  context.grafana.refresh();\n} else {\n  const errMsg = context.panel.response ? 'Failed to start orchestrator' : 'No response';\n  context.grafana.notifyError(['Orchestrator', errMsg]);\n}",
      "confirm": true,
      "contentType": "application/json",
      "getPayload": "const timeLimitEl = context.panel.elements.find(el => el.id === 'time_limit_minutes');\nconst timeLimit = timeLimitEl ? parseInt(timeLimitEl.value) : 30;\nreturn { time_limit_minutes: timeLimit };",
      "method": "POST",
      "payload": {},
      "payloadMode": "custom",
      "url": "http://${server}:${port}/api/v1/orchestrator/start"
    },
    "updateEnabled": "auto"
  },
  "pluginVersion": "6.3.1",
  "targets": [
    {
      "columns": [
        {
          "selector": "running",
          "text": "running",
          "type": "boolean"
        },
        {
          "selector": "job_id",
          "text": "job_id",
          "type": "string"
        },
        {
          "selector": "remaining_seconds",
          "text": "remaining_seconds",
          "type": "number"
        },
        {
          "selector": "time_limit_minutes",
          "text": "time_limit_minutes",
          "type": "number"
        },
        {
          "selector": "orchestrator_url",
          "text": "orchestrator_url",
          "type": "string"
        },
        {
          "selector": "last_error",
          "text": "last_error",
          "type": "string"
        }
      ],
      "datasource": {
        "type": "yesoreyeram-infinity-datasource",
        "uid": "af28rrswju6m8c"
      },
      "filters": [],
      "format": "table",
      "global_query_id": "",
      "parser": "backend",
      "refId": "status",
      "root_selector": "",
      "source": "url",
      "type": "json",
      "url": "/api/v1/orchestrator/status",
      "url_options": {
        "data": "",
        "method": "GET"
      }
    }
  ],
  "title": "Orchestrator Control",
  "transformations": [],
  "type": "volkovlabs-form-panel"
}
