{
  "datasource": {
    "type": "prometheus",
    "uid": "prom"
  },
  "fieldConfig": {
    "defaults": {},
    "overrides": []
  },
  "gridPos": {
    "h": 10,
    "w": 14,
    "x": 10,
    "y": 7
  },
  "id": 5,
  "options": {
    "buttonGroup": {
      "orientation": "center",
      "size": "lg"
    },
    "confirmModal": {
      "body": "Please confirm to update changed values",
      "cancel": "Cancel",
      "columns": {
        "include": [
          "name",
          "oldValue",
          "newValue"
        ],
        "name": "Label",
        "newValue": "New Value",
        "oldValue": "Old Value"
      },
      "confirm": "Confirm",
      "elementDisplayMode": "modified",
      "title": "Confirm update request"
    },
    "elementValueChanged": "",
    "elements": [
      {
        "allowCustomValue": false,
        "getOptions": "if (!context.panel.data || !context.panel.data.series || !context.panel.data.series[0]) return [];\nconst fields = context.panel.data.series[0].fields;\nconst ids = fields?.find(f => f.name === \"service_id\")?.values;\nconst values = fields?.find(f => f.type === \"number\" && f.name !== \"Time\")?.values;\nif (!ids || !values) return [];\nconst runningIds = ids.filter((id, i) => id && values[i] === 2);\nconst uniques = [...new Set(runningIds)].map(id => ({ label: id, value: id }));\nreturn uniques;",
        "id": "service_id",
        "labelWidth": 20,
        "options": [],
        "optionsSource": "Code",
        "section": "",
        "title": "Service ID",
        "tooltip": "",
        "type": "select",
        "uid": "aae2ed60-02b9-4a66-968a-5d05376598d7",
        "unit": "",
        "value": ""
      },
      {
        "id": "num_clients",
        "labelWidth": 20,
        "min": 1,
        "section": "",
        "title": "# of clients",
        "tooltip": "",
        "type": "number",
        "uid": "d5701437-b86d-4d94-ae96-fd84ec75b15b",
        "unit": "",
        "value": 0
      },
      {
        "id": "requests_per_minute",
        "labelWidth": 20,
        "min": 1,
        "section": "",
        "title": "Req/min",
        "tooltip": "Requests per minute (converted to req/s for API)",
        "type": "number",
        "uid": "8d5d6ae7-ff03-4792-a561-769bf7be5324",
        "unit": "",
        "value": 60
      },
      {
        "id": "duration_minutes",
        "labelWidth": 20,
        "min": 1,
        "section": "",
        "title": "Duration (min)",
        "tooltip": "Duration of the benchmark in minutes",
        "type": "number",
        "uid": "124316ac-6d60-440d-b228-568b1e4582e0",
        "unit": "",
        "value": 1
      },
      {
        "id": "max_tokens",
        "labelWidth": 20,
        "min": 1,
        "section": "",
        "title": "Max tokens",
        "tooltip": "",
        "type": "number",
        "uid": "0208340d-283e-4c83-a553-5a43b6403f65",
        "unit": "",
        "value": 0
      },
      {
        "id": "temperature",
        "labelWidth": 20,
        "max": 1,
        "min": 0,
        "section": "",
        "step": 0.01,
        "title": "Temperature",
        "tooltip": "",
        "type": "slider",
        "uid": "e0b30291-dac9-49fd-aaaa-941d1841516c",
        "unit": "",
        "value": 0
      },
      {
        "allowCustomValue": true,
        "id": "prompts",
        "labelWidth": 20,
        "options": [],
        "optionsSource": "Custom",
        "section": "",
        "title": "Prompts",
        "tooltip": "",
        "type": "multiselect",
        "uid": "5955cdab-3aa2-48c5-8d70-44de2ac82c40",
        "unit": "",
        "value": []
      }
    ],
    "initial": {
      "code": "context.panel.setFormValue({\n  num_clients: 10,\n  requests_per_minute: 60,\n  duration_minutes: 1,\n  max_tokens: 10,\n  temperature: 0.7,\n  prompts: [\n    \"Write a short poem about AI.\",\n    \"Explain what machine learning is.\",\n    \"Tell me a fun fact about computers.\",\n    \"What is Python programming?\"\n  ],\n})",
      "contentType": "application/json",
      "getPayload": "return {}",
      "highlight": false,
      "highlightColor": "red",
      "method": "query",
      "payload": {},
      "url": "/api/datasources/proxy/uid/af28rrswju6m8c/api/v1/recipes"
    },
    "layout": {
      "orientation": "horizontal",
      "padding": 10,
      "sectionVariant": "default",
      "variant": "single"
    },
    "reset": {
      "backgroundColor": "purple",
      "foregroundColor": "yellow",
      "icon": "process",
      "text": "Reset",
      "variant": "hidden"
    },
    "resetAction": {
      "code": "if (context.panel.response) {\n  context.grafana.notifySuccess(['Update', 'Values updated successfully.']);\n  context.grafana.refresh();\n} else {\n  context.grafana.notifyError(['Update', 'An error occurred updating values.']);\n}",
      "confirm": false,
      "getPayload": "return {}",
      "mode": "initial",
      "payload": {}
    },
    "saveDefault": {
      "icon": "save",
      "text": "Save Default",
      "variant": "hidden"
    },
    "submit": {
      "backgroundColor": "purple",
      "foregroundColor": "yellow",
      "icon": "play",
      "text": "Start benchmark",
      "variant": "primary"
    },
    "sync": true,
    "update": {
      "code": "if (context.panel.response && context.panel.response.ok) {\n  context.grafana.notifySuccess(['Benchmark started', 'Benchmark has been successfully started.']);\n  context.grafana.refresh();\n} else {\n  context.grafana.notifyError(['Unable to start benchmark', 'An error occurred starting the benchmark.']);\n}",
      "confirm": false,
      "contentType": "application/json",
      "getPayload": "console.log('getPayload called - elements:', context.panel.elements.map(e => ({id: e.id, value: e.value})));\nconst payload = {};\ncontext.panel.elements.forEach((element) => {\n  if (element.value === null || element.value === undefined || element.value === '') {\n    return;\n  }\n  if (element.id === 'service_id') {\n    payload.service_id = element.value;\n  } else if (element.id === 'num_clients') {\n    payload.num_clients = parseInt(element.value, 10);\n  } else if (element.id === 'requests_per_minute') {\n    payload.requests_per_second = parseFloat(element.value) / 60;\n  } else if (element.id === 'duration_minutes') {\n    payload.duration_seconds = parseInt(element.value, 10) * 60;\n  } else if (element.id === 'max_tokens') {\n    payload.max_tokens = parseInt(element.value, 10);\n  } else if (element.id === 'temperature') {\n    payload.temperature = parseFloat(element.value);\n  } else if (element.id === 'prompts') {\n    payload.prompts = element.value;\n  }\n});\nconsole.log('Benchmark payload:', JSON.stringify(payload));\nreturn payload;",
      "method": "POST",
      "payload": {},
      "payloadMode": "custom",
      "url": "/api/datasources/proxy/uid/client-infinity/api/v1/client-groups"
    },
    "updateEnabled": "auto"
  },
  "pluginVersion": "6.3.1",
  "targets": [
    {
      "datasource": {
        "type": "prometheus",
        "uid": "prom"
      },
      "editorMode": "code",
      "expr": "service_status_info",
      "instant": true,
      "legendFormat": "__auto",
      "range": false,
      "refId": "A"
    }
  ],
  "title": "Start benchmark",
  "transformations": [
    {
      "id": "labelsToFields",
      "options": {
        "keepLabels": [
          "service_id"
        ],
        "mode": "columns"
      }
    }
  ],
  "type": "volkovlabs-form-panel"
}