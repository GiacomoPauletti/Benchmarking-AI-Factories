Bootstrap: docker
From: python:3.11-slim

%post
    # Update system
    apt-get update && apt-get install -y \
        curl \
        wget \
        git \
        build-essential \
        && rm -rf /var/lib/apt/lists/*
    
    # Install Python testing dependencies
    pip install --no-cache-dir \
        pytest>=7.0.0 \
        pytest-mock>=3.10.0 \
        requests>=2.28.0 \
        fastapi>=0.100.0 \
        pyyaml>=6.0

%environment
    export PYTHONPATH=/app/services/server/src:$PYTHONPATH

%runscript
    #!/bin/bash
    
    echo "üß™ AI Factory Server Testing Container"
    echo "======================================"
    
    # Check if we're in the right directory
    if [ ! -f "/app/launch_server.sh" ]; then
        echo "‚ùå Error: Must bind mount the project directory to /app"
        echo "Usage: apptainer run --bind /path/to/Benchmarking-AI-Factories:/app test-container.sif"
        exit 1
    fi
    
    # Request interactive compute node for testing
    echo "üñ•Ô∏è  Requesting interactive compute node for testing..."
    salloc -A p200981 -t 00:15:00 -p cpu -q short -N 1 --ntasks-per-node=1 --mem=8G << 'TEST_EOF'
        echo "========================================="
        echo "Test node allocated: $(hostname)"
        echo "========================================="
        
        # Load required modules on compute node
        module load env/release/2023.1
        module load Apptainer/1.2.4-GCCcore-12.3.0
        
        cd /app
        
        # Step 1: Run unit tests first (no server needed)
        echo ""
        echo "üìã Step 1: Running unit tests..."
        cd /app/services/server
        
        if python -m pytest tests/test_api.py tests/test_slurm.py -v --tb=short; then
            echo "‚úÖ Unit tests passed"
        else
            echo "‚ùå Unit tests failed"
            exit 1
        fi
        
        # Step 2: Launch server in background
        echo ""
        echo "üöÄ Step 2: Launching server..."
        cd /app
        
        # Clean up any existing endpoint file
        rm -f .ai-factory-endpoint
        
        # Start server in background with timeout
        timeout 180 ./launch_server.sh &
        SERVER_PID=$!
        
        # Wait for server to be ready
        echo "‚è≥ Waiting for server to be ready..."
        RETRY_COUNT=0
        MAX_RETRIES=18  # Reduced for faster testing
        ENDPOINT=""
        
        while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if [ -f ".ai-factory-endpoint" ]; then
                ENDPOINT=$(cat .ai-factory-endpoint)
                if curl -s --connect-timeout 5 "$ENDPOINT/health" >/dev/null 2>&1; then
                    echo "‚úÖ Server is ready at $ENDPOINT"
                    break
                fi
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "   Waiting... ($RETRY_COUNT/$MAX_RETRIES)"
            sleep 10
        done
        
        if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
            echo "‚ùå Server failed to start within timeout"
            kill $SERVER_PID 2>/dev/null || true
            exit 1
        fi
        
        # Step 3: Run API integration tests
        echo ""
        echo "üîç Step 3: Running API tests..."
        cd /app/services/server
        
        if python -m pytest tests/test_integration.py -v --tb=short; then
            echo "‚úÖ Integration tests passed"
        else
            echo "‚ùå Integration tests failed"
            kill $SERVER_PID 2>/dev/null || true
            exit 1
        fi
        
        # Step 4: Run live API tests
        echo ""
        echo "üåê Step 4: Running live API tests..."
        
        # Test health endpoint
        echo "Testing health endpoint..."
        if curl -s "$ENDPOINT/health" | grep -q "healthy"; then
            echo "‚úÖ Health endpoint working"
        else
            echo "‚ùå Health endpoint failed"
            kill $SERVER_PID 2>/dev/null || true
            exit 1
        fi
        
        # Test root endpoint
        echo "Testing root endpoint..."
        if curl -s "$ENDPOINT/" | grep -q "AI Factory Server Service"; then
            echo "‚úÖ Root endpoint working"
        else
            echo "‚ùå Root endpoint failed"
            kill $SERVER_PID 2>/dev/null || true
            exit 1
        fi
        
        # Test recipes endpoint
        echo "Testing recipes endpoint..."
        if curl -s "$ENDPOINT/api/v1/recipes" | grep -q "\["; then
            echo "‚úÖ Recipes endpoint working"
        else
            echo "‚ùå Recipes endpoint failed"
            kill $SERVER_PID 2>/dev/null || true
            exit 1
        fi
        
        # Test service creation
        echo "Testing service creation..."
        SERVICE_RESPONSE=$(curl -s -X POST "$ENDPOINT/api/v1/services" \
            -H "Content-Type: application/json" \
            -d '{"recipe_name": "inference/vllm_dummy", "config": {"nodes": 1}}')
        
        if echo "$SERVICE_RESPONSE" | grep -q '"id"'; then
            SERVICE_ID=$(echo "$SERVICE_RESPONSE" | grep -o '"id":"[^"]*"' | cut -d'"' -f4)
            echo "‚úÖ Service creation working (ID: $SERVICE_ID)"
            
            # Test service listing
            echo "Testing service listing..."
            if curl -s "$ENDPOINT/api/v1/services" | grep -q "$SERVICE_ID"; then
                echo "‚úÖ Service listing working"
            else
                echo "‚ö†Ô∏è  Service listing may have issues"
            fi
        else
            echo "‚ùå Service creation failed"
            echo "Response: $SERVICE_RESPONSE"
            kill $SERVER_PID 2>/dev/null || true
            exit 1
        fi
        
        # Cleanup
        echo ""
        echo "üßπ Cleaning up..."
        kill $SERVER_PID 2>/dev/null || true
        sleep 5
        
        # Success!
        echo ""
        echo "üéâ All tests completed successfully!"
        echo "======================================"
        echo "Ready to commit and push your changes!"
        
TEST_EOF
    
%help
    This container runs comprehensive tests for the AI Factory Server.
    
    Usage:
        # Build the container
        cd /path/to/Benchmarking-AI-Factories/services/server
        apptainer build tests/test-container.sif tests/test-container.def
        
        # Run tests
        cd /path/to/Benchmarking-AI-Factories
        apptainer run --bind $(pwd):/app services/server/tests/test-container.sif
    
    What it does:
        1. Requests interactive compute node (15min, 8GB RAM)
        2. Runs unit tests (pytest)
        3. Launches the server using launch_server.sh
        4. Runs integration tests
        5. Tests live API endpoints
        6. Cleans up
    
    Requirements:
        - Must be run from the project root directory
        - Requires SLURM environment for server launch
        - Needs access to launch_server.sh script