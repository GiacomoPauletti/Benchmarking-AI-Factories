Bootstrap: docker
From: python:3.11-slim

%post
    export DEBIAN_FRONTEND=noninteractive
    # Workarounds for rootless/fakeroot builds
    rm -rf /var/lib/apt/lists/*
    apt-get clean
    echo 'APT::Sandbox::User "root";' > /etc/apt/apt.conf.d/99sandboxroot || true
    apt-get update --allow-releaseinfo-change || echo "Warning: apt-get update failed"
    apt-get install -y \
        curl \
        wget \
        git \
        build-essential \
        || echo "Warning: Some packages may not have installed correctly"
    apt-get clean || true
    rm -rf /var/lib/apt/lists/* || true
    
    # Create requirements file and install dependencies
    cat > /tmp/requirements-test.txt << 'REQ_EOF'
pytest>=7.0.0
pytest-mock>=3.10.0
requests>=2.28.0
fastapi>=0.100.0
PyYAML>=6.0
uvicorn[standard]>=0.23.0
REQ_EOF
    
    # Verify requirements file and install dependencies
    echo "Requirements file contents:"
    cat /tmp/requirements-test.txt
    pip install --no-cache-dir -r /tmp/requirements-test.txt

%environment
    export PYTHONPATH=/app/services/server/src:$PYTHONPATH

%runscript
    #!/bin/bash
    
    echo "Server Testing Container"
    echo "======================================"
    
    # Check if we're in the right directory
    if [ ! -f "/app/services/server/launch_server.sh" ]; then
        echo "Error: Must bind mount the project directory to /app"
        echo "Usage: apptainer run --bind /path/to/Benchmarking-AI-Factories:/app test-container.sif"
        exit 1
    fi
    
    echo "Running tests on compute node: $(hostname)"
    echo "========================================="
    
    # Load required modules 
    module load env/release/2023.1
    module load Apptainer/1.2.4-GCCcore-12.3.0
    
    cd /app
    
    #### UNIT TESTS ####
    # Run unit tests first (no server needed)
    echo ""
    echo "Running unit tests..."
    cd /app/services/server
    UNIT_LOG="tests/unit-test.log"
    python -m pytest tests/test_api.py -v --tb=short > "$UNIT_LOG" 2>&1
    UNIT_STATUS=$?
    if [ $UNIT_STATUS -eq 0 ]; then
        echo "Unit tests passed (see $UNIT_LOG)"
    else
        echo "Unit tests failed (see $UNIT_LOG)"
        exit 1
    fi

    #### INTEGRATION AND LIVE TESTS ####
    echo ""
    echo "Launching server..."
    cd /app
    
    # Clean up any existing endpoint file
    rm -f services/server/.server-endpoint
    
    # Start FastAPI server directly for integration tests
    cd /app/services/server/src
    export PORT=${PORT:-8001}
    python -m uvicorn main:app --host 0.0.0.0 --port $PORT &
    SERVER_PID=$!
    cd /app

    # Write endpoint file for test discovery
    SERVER_ENDPOINT="http://localhost:$PORT"
    echo "$SERVER_ENDPOINT" > services/server/.server-endpoint

    # Wait for server to be ready (max 60s)
    echo "Waiting for server to start..."
    for i in {1..60}; do
        if curl -s $SERVER_ENDPOINT/health >/dev/null 2>&1; then
            echo "Health endpoint reachable. Server is up."
            break
        fi
        sleep 1
    done
    if ! curl -s $SERVER_ENDPOINT/health >/dev/null 2>&1; then
        echo "Server failed to start within timeout."
        kill $SERVER_PID 2>/dev/null || true
        exit 1
    fi
    echo "Server started at: $SERVER_ENDPOINT"
    
    # Run API integration tests
    echo ""
    echo "Running integration tests..."
    cd /app/services/server
    INTEGRATION_LOG="tests/integration-test.log"
    python -m pytest tests/test_integration.py -v --tb=short > "$INTEGRATION_LOG" 2>&1
    INTEGRATION_STATUS=$?
    if [ $INTEGRATION_STATUS -eq 0 ]; then
        echo "Integration tests passed (see $INTEGRATION_LOG)"
    else
        echo "Integration tests failed (see $INTEGRATION_LOG)"
        kill $SERVER_PID 2>/dev/null || true
        exit 1
    fi
    
    # Cleanup
    echo ""
    echo "Cleaning up..."
    kill $SERVER_PID 2>/dev/null || true
    sleep 5
    
    # Success!
    echo ""
    echo "All tests completed successfully!"
    echo "======================================"
    echo "Ready to commit and push your changes!"
    
%help
    This container runs tests for the Server.
    
    Usage:
        # Build the container
        cd /path/to/Benchmarking-AI-Factories/services/server
        apptainer build tests/test-container.sif tests/test-container.def
        
        # Run tests
        cd /path/to/Benchmarking-AI-Factories
        apptainer run --bind $(pwd):/app services/server/tests/test-container.sif
    
    What it does:
        1. Requests interactive compute node (15min, 8GB RAM)
        2. Runs unit tests (pytest)
        3. Launches the server using launch_server.sh
        4. Runs integration tests
        5. Cleans up
