Bootstrap: docker
From: qdrant/qdrant:latest

%labels
    Description "Apptainer container for Qdrant vector database"
    Version latest

%post
    mkdir -p /qdrant_data
    chmod -R 777 /qdrant_data

%environment
    # Storage path will be set via APPTAINERENV_QDRANT__STORAGE__STORAGE_PATH from SLURM job

%runscript
    echo "Starting Qdrant vector database..."
    
    # Use job-specific storage path if provided, otherwise use default
    # This allows multiple Qdrant instances to run simultaneously
    STORAGE_PATH="${QDRANT__STORAGE__STORAGE_PATH:-/workspace/qdrant_data}"
    echo "Storage: ${STORAGE_PATH}"
    
    # Ensure storage directory exists
    mkdir -p "${STORAGE_PATH}"
    
    # Find and execute qdrant binary
    if [ -f /qdrant/qdrant ]; then
        exec /qdrant/qdrant
    elif [ -f ./qdrant ]; then
        exec ./qdrant
    elif command -v qdrant >/dev/null 2>&1; then
        exec qdrant
    else
        echo "ERROR: qdrant binary not found"
        exit 1
    fi
