global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  # Scrape Prometheus itself
  - job_name: "prometheus"
    static_configs:
      - targets: ["localhost:9090"]

  # Scrape Loki metrics
  - job_name: "loki"
    metrics_path: "/metrics"  # Loki's metrics endpoint
    static_configs:
      - targets: ["loki:3100"]

  # Scrape Client Service metrics
  - job_name: "client_service"
    metrics_path: "/metrics"
    static_configs:
      - targets: ["client:8002"]

  # Scrape application metrics
  #- job_name: "application"
  #  metrics_path: "/api/metrics"  # TODO: server metrics endpoint
  #  static_configs:
  #    - targets: ["server:8001"]

  - job_name: "services"
    http_sd_configs:
      - url: "http://server:8001/api/v1/services/targets"
        refresh_interval: 15s
    scrape_interval: 5s
    # Transform the discovered targets from <service> to host:port and the corresponding URL
    relabel_configs:
      # Preserve the discovered identifier (job or job:port) for uniqueness.
      - source_labels: [service_id]
        regex:  '(.*)'
        replacement: '$1'
        target_label: replica_id

      - source_labels: [service_id]
        regex:  '(.*)'
        replacement: '/api/v1/services/$1/metrics'
        target_label: __metrics_path__

      # Group services by replica group id when available (multi-node).
      - source_labels: [group_id]
        regex:  '(.+)'
        replacement: '$1'
        target_label: service_id

      # Fallback: if service_id is still in the form "job_id:port", normalize to just job_id.
      # This prevents the main dashboard from showing one bar per replica when group_id is absent.
      - source_labels: [service_id]
        regex:  '(.*):(.*)'
        replacement: '$1'
        target_label: service_id

      # If replica_id is in the form "job_id:port", extract port as replica_no.
      - source_labels: [replica_id]
        regex:  '(.*):(.*)'
        replacement: '$2'
        target_label: replica_no

      # If replica_id is in the form "job_id:port", extract job id for legends/debug.
      - source_labels: [replica_id]
        regex:  '(.*):(.*)'
        replacement: '$1'
        target_label: node_job_id

      - source_labels: [__address__]
        regex:  '.*'
        replacement: 'server:8001'
        target_label: __address__